name: Documentation (python 3.11)

on:
    release:
        types: [published]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    docs:
        runs-on: ubuntu-latest
        steps:
        -   uses: actions/checkout@v6

        -   name: Install uv
            uses: astral-sh/setup-uv@v7
            with:
                enable-cache: true
                python-version: "3.11"

        # Install docs dependencies
        -   name: Install docs dependencies
            run: |
                sudo apt-get install -y pandoc
                uv sync --locked --extra docs


        # Test and build the docs
        -   name: Test and build docs
            run: |
                uv run python -m sphinx -M doctest ./docs ./docs/_build
                uv run python -m sphinx -M coverage ./docs ./docs/_build
                uv run python -m sphinx -M html ./docs ./docs/_build


        # Upload static files as artifact
        # https://github.com/actions/upload-pages-artifact
        -   name: Upload static files as artifact
            id: deployment
            uses: actions/upload-pages-artifact@v4
            with:
                path: ./docs/_build/html


    deploy:
        # Deployment job
        needs: docs

        permissions:
            pages: write      # to deploy to Pages
            id-token: write

        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        runs-on: ubuntu-latest

        steps:
            -   name: Deploy to GitHub Pages
                id: deployment
                uses: actions/deploy-pages@v4
